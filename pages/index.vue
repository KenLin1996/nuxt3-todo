<script setup lang="ts">
import { ref } from "vue";
import { useTodoStore } from "../stores/todo.ts";
import { storeToRefs } from "pinia";
import draggable from "vuedraggable";

// Todo 輸入欄位的內容
const todoText = ref<string>("");

const todoStore = useTodoStore();

// 切換狀態、刪除功能
const { deleteTodo, setFilter } = todoStore;

const { todos, filterState } = storeToRefs(todoStore);

// 處理新增 Todo
const addTodo = () => {
  const text = todoText.value.trim();
  if (!text) return;

  todoStore.addTodo(text);
  todoText.value = "";
};

// 根據篩選條件來判斷 Todo 是否顯示
const shouldDisplay = (todo: { completed: boolean }) => {
  if (filterState.value === "completed") {
    return todo.completed;
  } else if (filterState.value === "active") {
    return !todo.completed;
  }
  return true;
};
</script>

<template>
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-4">📝 Nuxt 3 Todo List</h1>

    <!-- 狀態篩選 -->
    <div class="flex justify-center space-x-2 mb-4">
      <button
        @click="setFilter('all')"
        :class="
          filterState === 'all' ? 'text-blue-500 font-bold' : 'text-gray-500'
        "
      >
        全部
      </button>
      <button
        @click="setFilter('active')"
        :class="
          filterState === 'active' ? 'text-blue-500 font-bold' : 'text-gray-500'
        "
      >
        未完成
      </button>
      <button
        @click="setFilter('completed')"
        :class="
          filterState === 'completed'
            ? 'text-blue-500 font-bold'
            : 'text-gray-500'
        "
      >
        已完成
      </button>
    </div>

    <!-- 輸入 Todo -->
    <div class="flex gap-2 mb-2 justify-center">
      <input
        v-model="todoText"
        type="text"
        class="px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
        placeholder="請輸入待辦事項..."
      />
      <button
        @click="addTodo"
        class="bg-blue-500 text-white rounded px-4 py-2 hover:bg-blue-600 cursor-pointer"
      >
        新增
      </button>
    </div>

    <!-- 顯示 Todo 清單 -->

    <ul class="space-y-2">
      <draggable
        v-model="todos"
        item-key="id"
        class="space-y-2"
        ghost-class="opacity-50"
      >
        <template #item="{ element: todo }">
          <li
            v-if="shouldDisplay(todo)"
            class="flex items-center justify-between p-2 bg-white rounded shadow"
          >
            <label class="flex items-center space-x-2">
              <input
                type="checkbox"
                v-model="todo.completed"
                class="form-checkbox"
              />
              <span :class="{ 'line-through text-gray-400': todo.completed }">
                {{ todo.text }}
              </span>
            </label>
            <button
              @click="deleteTodo(todo.id)"
              class="text-red-500 hover:text-red-700"
            >
              刪除
            </button>
          </li>
        </template>
      </draggable>
    </ul>
  </div>
</template>
